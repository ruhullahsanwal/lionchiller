function initScreenAnd3D(){HEIGHT=window.innerHeight,WIDTH=window.innerWidth,windowHalfX=WIDTH/2,windowHalfY=HEIGHT/2,scene=new THREE.Scene,aspectRatio=WIDTH/HEIGHT,fieldOfView=50,nearPlane=1,farPlane=2e3,camera=new THREE.PerspectiveCamera(fieldOfView,aspectRatio,nearPlane,farPlane),camera.position.x=0,camera.position.z=300,camera.position.y=250,camera.lookAt(new THREE.Vector3(0,60,0)),renderer=new THREE.WebGLRenderer({alpha:!0,antialias:!0}),renderer.setSize(WIDTH,HEIGHT),renderer.shadowMapEnabled=!0,container=document.getElementById("world"),container.appendChild(renderer.domElement),window.addEventListener("resize",handleWindowResize,!1),document.addEventListener("mousemove",handleMouseMove,!1),document.addEventListener("touchmove",handleTouchMove,!1)}function handleWindowResize(){HEIGHT=window.innerHeight,WIDTH=window.innerWidth,windowHalfX=WIDTH/2,windowHalfY=HEIGHT/2,renderer.setSize(WIDTH,HEIGHT),camera.aspect=WIDTH/HEIGHT,camera.updateProjectionMatrix()}function handleMouseMove(a){mousePos={x:a.clientX,y:a.clientY}}function handleTouchMove(a){1==a.touches.length&&(a.preventDefault(),mousePos={x:a.touches[0].pageX,y:a.touches[0].pageY})}function createLights(){globalLight=new THREE.HemisphereLight(16777215,16777215,.5),shadowLight=new THREE.DirectionalLight(16777215,.9),shadowLight.position.set(200,200,200),shadowLight.castShadow=!0,shadowLight.shadowDarkness=.2,shadowLight.shadowMapWidth=shadowLight.shadowMapHeight=2048,backLight=new THREE.DirectionalLight(16777215,.4),backLight.position.set(-100,100,100),backLight.castShadow=!0,backLight.shadowDarkness=.1,backLight.shadowMapWidth=shadowLight.shadowMapHeight=2048,scene.add(globalLight),scene.add(shadowLight),scene.add(backLight)}function createFloor(){floor=new THREE.Mesh(new THREE.PlaneBufferGeometry(1e3,1e3),new THREE.MeshBasicMaterial({color:7261388})),floor.rotation.x=-Math.PI/2,floor.position.y=0,floor.receiveShadow=!0,scene.add(floor)}function createHero(){hero=new Cat,scene.add(hero.threeGroup)}function createBall(){ball=new Ball,scene.add(ball.threeGroup)}function loop(){render(),t+=.05,hero.updateTail(t);var a=getBallPos();ball.update(a.x,a.y,a.z),ball.receivePower(hero.transferPower),hero.interactWithBall(ball.body.position),requestAnimationFrame(loop)}function getBallPos(){var a=new THREE.Vector3;a.set(mousePos.x/window.innerWidth*2-1,2*-(mousePos.y/window.innerHeight)+1,.1),a.unproject(camera);var b=a.sub(camera.position).normalize(),c=(ballWallDepth-camera.position.z)/b.z,d=camera.position.clone().add(b.multiplyScalar(c));return d}function render(){controls&&controls.update(),renderer.render(scene,camera)}function init(a){initScreenAnd3D(),createLights(),createFloor(),createHero(),createBall(),loop()}var scene,camera,fieldOfView,aspectRatio,nearPlane,farPlane,gobalLight,shadowLight,backLight,renderer,container,controls,HEIGHT,WIDTH,windowHalfX,windowHalfY,mousePos={x:0,y:0},oldMousePos={x:0,y:0},ballWallDepth=28,hero,woolNodes=10,woolSegLength=2,gravity=-.8,accuracy=1;Ball=function(){var a=new THREE.MeshLambertMaterial({color:6491413,shading:THREE.FlatShading}),b=new THREE.LineBasicMaterial({color:6491413,linewidth:3});this.threeGroup=new THREE.Group,this.ballRay=8,this.verts=[];for(var c=new THREE.Geometry,d=0;d<woolNodes;d++){var e=new THREE.Vector3(0,-d*woolSegLength,0);c.vertices.push(e);var f=new WoolVert;f.x=f.oldx=e.x,f.y=f.oldy=e.y,f.z=0,f.fx=f.fy=0,f.isRootNode=0==d,f.vertex=e,d>0&&f.attach(this.verts[d-1]),this.verts.push(f)}this.string=new THREE.Line(c,b);var g=new THREE.SphereGeometry(this.ballRay,5,4);this.body=new THREE.Mesh(g,a),this.body.position.y=-woolSegLength*woolNodes;var h=new THREE.TorusGeometry(this.ballRay,.5,3,10,2*Math.PI);this.wire1=new THREE.Mesh(h,a),this.wire1.position.x=1,this.wire1.rotation.x=-Math.PI/4,this.wire2=this.wire1.clone(),this.wire2.position.y=1,this.wire2.position.x=-1,this.wire1.rotation.x=-Math.PI/4+.5,this.wire1.rotation.y=-Math.PI/6,this.wire3=this.wire1.clone(),this.wire3.rotation.x=-Math.PI/2+.3,this.wire4=this.wire1.clone(),this.wire4.position.x=-1,this.wire4.rotation.x=-Math.PI/2+.7,this.wire5=this.wire1.clone(),this.wire5.position.x=2,this.wire5.rotation.x=-Math.PI/2+1,this.wire6=this.wire1.clone(),this.wire6.position.x=2,this.wire6.position.z=1,this.wire6.rotation.x=1,this.wire7=this.wire1.clone(),this.wire7.position.x=1.5,this.wire7.rotation.x=1.1,this.wire8=this.wire1.clone(),this.wire8.position.x=1,this.wire8.rotation.x=1.3,this.wire9=this.wire1.clone(),this.wire9.scale.set(1.2,1.1,1.1),this.wire9.rotation.z=Math.PI/2,this.wire9.rotation.y=Math.PI/2,this.wire9.position.y=1,this.body.add(this.wire1),this.body.add(this.wire2),this.body.add(this.wire3),this.body.add(this.wire4),this.body.add(this.wire5),this.body.add(this.wire6),this.body.add(this.wire7),this.body.add(this.wire8),this.body.add(this.wire9),this.threeGroup.add(this.string),this.threeGroup.add(this.body),this.threeGroup.traverse(function(a){a instanceof THREE.Mesh&&(a.castShadow=!0,a.receiveShadow=!0)})},WoolVert=function(){this.x=0,this.y=0,this.z=0,this.oldx=0,this.oldy=0,this.fx=0,this.fy=0,this.isRootNode=!1,this.constraints=[],this.vertex=null},WoolVert.prototype.update=function(){var a=0;this.add_force(a,gravity),nx=this.x+.9*(this.x-this.oldx)+this.fx,ny=this.y+.9*(this.y-this.oldy)+this.fy,this.oldx=this.x,this.oldy=this.y,this.x=nx,this.y=ny,this.vertex.x=this.x,this.vertex.y=this.y,this.vertex.z=this.z,this.fy=this.fx=0},WoolVert.prototype.attach=function(a){this.constraints.push(new Constraint(this,a))},WoolVert.prototype.add_force=function(a,b){this.fx+=a,this.fy+=b},Constraint=function(a,b){this.p1=a,this.p2=b,this.length=woolSegLength},Ball.prototype.update=function(a,b,c){for(var d=accuracy;d--;)for(var e=woolNodes;e--;){var f=this.verts[e];if(f.isRootNode)f.x=a,f.y=b,f.z=c;else{for(var g=f.constraints.length;g--;){var h=f.constraints[g],i=h.p1.x-h.p2.x,j=h.p1.y-h.p2.y,k=Math.sqrt(i*i+j*j),l=(h.length-k)/k,m=i*l*.5,n=j*l*.5;h.p1.x+=m,h.p1.y+=n,h.p2.x-=m,h.p2.y-=n,h.p1.z=h.p2.z=c}e==woolNodes-1&&(this.body.position.x=this.verts[e].x,this.body.position.y=this.verts[e].y,this.body.position.z=this.verts[e].z,this.body.rotation.z+=f.y<=this.ballRay?(f.oldx-f.x)/10:Math.min(Math.max(i/2,-.1),.1))}f.y<this.ballRay&&(f.y=this.ballRay)}for(e=woolNodes;e--;)this.verts[e].update();this.string.geometry.verticesNeedUpdate=!0},Ball.prototype.receivePower=function(a){this.verts[woolNodes-1].add_force(a.x,a.y)};var t=0;window.addEventListener("load",init,!1);